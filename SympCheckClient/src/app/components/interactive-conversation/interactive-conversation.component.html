<div class="interactive-conversation-container">
  <!-- Error Display -->
  <div *ngIf="error" class="error-alert">
    <p>{{ error }}</p>
    <button *ngIf="errorStatus !== 429" (click)="retry()" class="retry-btn">Retry</button>
  </div>

  <!-- Global Loading while fetching next question (when no question is available yet) -->
  <div *ngIf="isLoading && !currentQuestion" class="loading-spinner">
    <svg class="ecg" viewBox="0 0 200 40" preserveAspectRatio="none" aria-hidden="true">
      <path
        d="M0 20 L30 20 L40 20 L45 5 L55 35 L65 10 L75 30 L85 20 L120 20 L130 20 L135 8 L145 32 L155 12 L165 28 L175 20 L200 20" />
    </svg>
    <p>Getting next question...</p>
  </div>


  <!-- Show Question -->
  <div
    *ngIf="(state?.phase === 'initial' || state?.phase === 'asking-questions' || state?.phase === 'asking-additional') && currentQuestion"
    class="question-section">
    <div class="question-card">


      <h3>{{ currentQuestion.question }}</h3>

      <!-- Multiple Choice Options -->
      <div *ngIf="currentQuestion.options && currentQuestion.options.length > 0" class="options-container">
        <button *ngFor="let option of currentQuestion.options" type="button" [class.active]="selectedOption === option"
          (click)="selectedOption = option" class="option-button">
          {{ option }}
        </button>
      </div>

      <!-- Text Answer -->
      <div *ngIf="!currentQuestion.options || currentQuestion.options.length === 0" class="text-answer">
        <textarea [(ngModel)]="userTextAnswer" (ngModelChange)="filterSymptoms()" 
          rows="4"></textarea>

        <!-- Guidance Overlay for Initial Symptom (Visible when empty) -->
        <div *ngIf="!initialSymptomSubmitted && !userTextAnswer" class="guidance-overlay fade-in">
          <p>For the most accurate results, please describe your symptoms and conditions clearly. Only input medical symptoms and conditions.</p>
        </div>

        <!-- Autocomplete suggestions for initial symptom -->
        <div *ngIf="!initialSymptomSubmitted && filteredSymptoms.length > 0" class="autocomplete-dropdown">
          <button *ngFor="let symptom of filteredSymptoms" type="button" class="autocomplete-item"
            (click)="selectSymptom(symptom)">
            {{ symptom }}
          </button>
        </div>
      </div>

      <!-- Action Buttons -->
      <div class="action-buttons">
        <div *ngIf="isLoading" class="loading-next-question">
          <div *ngIf="lastSubmittedAnswer" class="submitted-answer">
            <strong>Your answer:</strong> {{ lastSubmittedAnswer }}
          </div>
          <svg class="ecg-small" viewBox="0 0 200 40" preserveAspectRatio="none" aria-hidden="true">
            <path
              d="M0 20 L30 20 L40 20 L45 5 L55 35 L65 10 L75 30 L85 20 L120 20 L130 20 L135 8 L145 32 L155 12 L165 28 L175 20 L200 20" />
          </svg>
          <p>Getting next question...</p>
        </div>
        <ng-container *ngIf="!isLoading">
          <button type="button" (click)="skipQuestion()" class="btn-skip" [disabled]="!initialSymptomSubmitted">
            Skip
          </button>
          <button type="button" (click)="submitAnswer()" class="btn-submit" [disabled]="isAnswerInvalid">
            Submit Answer
          </button>
        </ng-container>
      </div>
    </div>
  </div>

  <!-- More Questions Prompt -->
  <div *ngIf="state?.phase === 'more-questions-prompt'" class="prompt-section">
    <div class="prompt-card">
      <h3>Would you like more follow-up questions?</h3>
      <div *ngIf="isLoading" class="loading-next-question">
        <svg class="ecg-small" viewBox="0 0 200 40" preserveAspectRatio="none" aria-hidden="true">
          <path
            d="M0 20 L30 20 L40 20 L45 5 L55 35 L65 10 L75 30 L85 20 L120 20 L130 20 L135 8 L145 32 L155 12 L165 28 L175 20 L200 20" />
        </svg>
        <p>Getting next question...</p>
      </div>
      <div class="button-group" *ngIf="!isLoading">
        <button type="button" (click)="respondToMoreQuestionsPrompt(false)" class="btn-no">
          No
        </button>
        <button type="button" (click)="respondToMoreQuestionsPrompt(true)" class="btn-yes">
          Yes
        </button>
      </div>
    </div>
  </div>

  <!-- Count Prompt -->
  <div *ngIf="state?.phase === 'more-questions-count'" class="prompt-section">
    <div class="prompt-card">
      <h3>How many additional follow-up questions would you like (1-10)?</h3>
      <div class="numeric-input">
        <input type="number" [(ngModel)]="numericAnswer" min="1" max="10" placeholder="Enter number..." />
      </div>
      <div *ngIf="isLoading" class="loading-next-question">
        <svg class="ecg-small" viewBox="0 0 200 40" preserveAspectRatio="none" aria-hidden="true">
          <path
            d="M0 20 L30 20 L40 20 L45 5 L55 35 L65 10 L75 30 L85 20 L120 20 L130 20 L135 8 L145 32 L155 12 L165 28 L175 20 L200 20" />
        </svg>
        <p>Getting next question...</p>
      </div>
      <button type="button" (click)="respondToCountPrompt()" class="btn-submit" *ngIf="!isLoading" [disabled]="isCountInvalid">
        Continue
      </button>
    </div>
  </div>

  <!-- Conversation Complete -->
  <div *ngIf="state?.phase === 'complete'" class="completion-section">
    <div class="completion-card">
      <div class="completion-icon">âœ“</div>
      <h3>Conversation Complete</h3>
      <p>Thank you for your responses. Proceeding to the next step...</p>
    </div>
  </div>
</div>