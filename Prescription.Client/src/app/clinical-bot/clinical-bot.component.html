<div class="clinical-bot-app">
  <!-- Top Navigation Bar -->
  <header class="top-nav-bar">
    <div class="nav-left">
      <i class="fa-solid fa-robot ai-icon"></i>
      <span class="app-title">AI Clinical Note Processor</span>
    </div>
    <div class="nav-right">
      <span class="nav-subtitle">Transform clinical notes into structured prescription data</span>
    </div>
  </header>

  @let _isStreaming = isStreaming();
  @let _isProcessing = isProcessing();

  <!-- Main Content Area -->
  <div class="main-content">
    <!-- Input Panel -->
    <div class="panel panel-input">
      <div class="panel-header">
        <div class="panel-title-bar">
          <span class="panel-title">
            <i class="fa-solid fa-file-medical"></i> Clinical Note Input
            (Multi-Language)
          </span>
          <app-speech-recorder [disabled]="_isStreaming || _isProcessing"
                               [showLivePreview]="true"
                               (transcriptionChange)="onSpeechTranscription($event)"
                               (realtimeText)="onRealtimeText($event)"
                               (segmentComplete)="onSegmentComplete($event)"
                               (recordingStateChange)="onRecordingStateChange($event)"
                               (error)="onSpeechError($event)" />
        </div>

        <div class="panel-actions">
          <button type="button"
                  class="btn-lang"
                  (click)="loadSampleNote()"
                  [disabled]="_isStreaming || _isProcessing">
            <span class="lang-flag">ðŸ‡¬ðŸ‡§</span> EN
          </button>
          <button type="button"
                  class="btn-lang"
                  (click)="loadBengaliSample()"
                  [disabled]="_isStreaming || _isProcessing">
            <span class="lang-flag">ðŸ‡§ðŸ‡©</span> à¦¬à¦¾à¦‚
          </button>
          <button type="button"
                  class="btn-lang"
                  (click)="loadHindiSample()"
                  [disabled]="_isStreaming || _isProcessing">
            <span class="lang-flag">ðŸ‡®ðŸ‡³</span> à¤¹à¤¿
          </button>
          <button type="button"
                  class="btn-icon"
                  (click)="clearNote()"
                  [disabled]="_isStreaming || _isProcessing"
                  title="Clear">
            <i class="fa-solid fa-eraser"></i>
          </button>
          <button type="button"
                  class="btn-icon"
                  (click)="generateMeetingSummary()"
                  [disabled]="_isStreaming || _isProcessing"
                  title="Meeting Summary">
            <i class="fa-solid fa-list-alt"></i>
          </button>
        </div>
      </div>
      <div class="panel-content">
        <!-- Clinical Note Input with pending text indicator -->
        <div class="textarea-wrapper" [class.has-pending]="pendingText()">
          <textarea class="clinical-note-input"
                    [value]="clinicalNote()"
                    (input)="onTextareaInput($any($event.target).value)"
                    rows="14"
                    [class.recording-active]="isRecording()"
                    placeholder="Paste your clinical note here or click the microphone to dictate...

Example format:
Patient: John Doe, 45-year-old male
Chief Complaint: Persistent cough and fever for 3 days

History: Patient reports dry cough, fever up to 101Â°F
Physical Exam: BP 120/80, Pulse 88/min, Temp 100.4Â°F
Diagnosis: Upper Respiratory Tract Infection
Plan: Rest, fluids, Paracetamol 500mg TDS x 5 days"
                    [disabled]="_isStreaming || _isProcessing">
          </textarea>

          <!-- Pending text indicator overlay -->
          @if (isRecording() && pendingText()) {
          <div class="pending-text-indicator">
            <span class="pending-label">
              <i class="fa-solid fa-circle pending-dot"></i>
              Listening...
            </span>
            <span class="pending-preview">{{ pendingText() }}</span>
          </div>
          }
        </div>

        @if (errorMessage()) {
        <div class="error-banner">
          <i class="fa-solid fa-exclamation-circle"></i>
          <span>{{ errorMessage() }}</span>
        </div>
        }

        <div class="action-bar">
          <button type="button"
                  class="btn-action btn-stream"
                  (click)="streamSummary()"
                  [disabled]="_isStreaming || _isProcessing || !clinicalNote().trim()">
            <i class="fa-solid fa-bolt" [class.fa-spin]="_isStreaming"></i>
            {{ _isStreaming ? "Streaming..." : "Stream Process" }}
          </button>
          <button type="button"
                  class="btn-action btn-generate"
                  (click)="getCompleteSummary()"
                  [disabled]="_isStreaming || _isProcessing || !clinicalNote().trim()">
            <i class="fa-solid fa-wand-magic-sparkles"
               [class.fa-spin]="_isProcessing"></i>
            {{ _isProcessing ? "Processing..." : "Generate Prescription" }}
          </button>
        </div>
      </div>
    </div>

    <!-- Response Panel -->
    @if (aiResponse()) {
    <div class="panel panel-response">
      <div class="panel-header panel-header-success">
        <span class="panel-title"><i class="fa-solid fa-sparkles"></i> AI Analysis Result</span>
        <span class="status-badge">
          <i class="fa-solid fa-check-circle"></i> Complete
        </span>
      </div>
      <div class="panel-content">
        <div class="response-box">
          <pre class="response-text">{{ aiResponse() }}</pre>
        </div>
        <div class="redirect-notice">
          <i class="fa-solid fa-arrow-right"></i>
          <span>Analysis complete! Redirecting to prescription form...</span>
        </div>
      </div>
    </div>
    }
  </div>

  <!-- Meeting Summary Popup -->
  <app-meeting-summary-popup
    [isOpen]="isSummaryPopupOpen()"
    [response]="meetingSummaryResponse()"
    [error]="meetingSummaryError()"
    (close)="closeSummaryPopup()" />
</div>
